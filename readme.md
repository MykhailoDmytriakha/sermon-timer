# Three‑Part Timer for Wear OS (Galaxy Watch 5)

> **Коротко:** таймер из **трёх последовательных секций** — *Вступление → Основная → Заключение*. Старт в одно касание из **Tile** (свайп вправо на часах). На границах секций — **вибро‑сигналы** и визуальная индикация. Пресеты (например, «Проповедь 5‑20‑5») настраиваются в приложении.

---

## Содержание

* [Замысел](#замысел)
* [Концепция](#концепция)
* [Принципы работы](#принципы-работы)
* [Целевая аудитория и сценарии использования](#целевая-аудитория-и-сценарии-использования)
* [Требования](#требования)
* [Архитектура и компоненты](#архитектура-и-компоненты)
* [Состояния и основной поток (flow)](#состояния-и-основной-поток-flow)
* [Экраны, действия, маршрутизация](#экраны-действия-маршрутизация)
* [UX‑решения для зала/кафедры](#ux-решения-для-залакатедры)
* [Правила и крайние случаи](#правила-и-крайние-случаи)
* [Конфиденциальность и безопасность](#конфиденциальность-и-безопасность)
* [Сборка и запуск (для разработчика)](#сборка-и-запуск-для-разработчика)
* [Тест‑план (качество и надёжность)](#тест-план-качество-и-надёжность)
* [Ограничения платформы и компромиссы](#ограничения-платформы-и-компромиссы)
* [Дорожная карта](#дорожная-карта)
* [Глоссарий](#глоссарий)

---

## Замысел

В публичных выступлениях (проповедь, малая группа, доклад) важно держать **структуру времени**. Человек помнит объём целиком (например, 30 минут), но реальный контроль происходит на **переходах**: закончить вступление вовремя, не «проесть» заключение. Этот проект даёт простой, тактильно‑очевидный инструмент: **один жест → один старт → три чётких рубежа**.

### Цели

* Упростить контроль времени **без визуального контакта** с экраном.
* Уменьшить когнитивную нагрузку: не считать минуты, а реагировать на **вибро‑сигналы**.
* Сделать старт **в одно касание** из системной поверхности (Tile), без «копания» в приложениях.

---

## Концепция

* **Пресет**: имя + три длительности (секунд/минуты) — `intro`, `main`, `outro`.
* **Запуск**: свайп вправо → **Tile** → большая кнопка **Start** для текущего (дефолтного) пресета.
* **Индикация**: кольцевой прогресс, подпись текущей секции (I / M / O), цветовая подсветка.
* **Рубежи**: 3 отличимых вибро‑паттерна; на финале — «торжественный» шаблон.
* **Управление**: Pause/Resume/Stop/Skip доступно из уведомления и экрана таймера.

---

## Принципы работы

1. **Надёжность важнее анимаций**: таймер живёт в Foreground‑сервисе; завершение секций фиксируется чётко (точный аларм или монотонные часы + коррекция дрейфа).
2. **Тишина по умолчанию**: звук опционален; основная обратная связь — вибрация.
3. **Один взгляд — одна мысль**: на экране крупно остаток **текущей секции** и явная метка фазы.
4. **Минимум трения**: быстрый старт с Tile; редактирование пресетов — заранее.
5. **Восстановимость**: после перезагрузки/краша состояние восстанавливается.

---

## Целевая аудитория и сценарии использования

**Кто:** проповедники, ведущие малых групп, лекторы, модераторы.

**Типовые сценарии:**

* S1: *«Проповедь 5‑20‑5»*. Перед началом выбрал пресет, на кафедре свайп вправо → Start.
* S2: *«Малая группа 3‑12‑3»*. Быстрая корректировка пресета, запуск с Tile.
* S3: *«Доклад 2‑7‑1»*. Пауза на вопрос → возобновление из уведомления.
* S4: *«Длинная речь 10‑30‑5»*. Перерасход основной части — контролируем рубежом.

---

## Требования

### Функциональные

* Пресеты: до 5 (минимум 3 по умолчанию), имя + 3 длительности.
* Старт из Tile, пауза/возобновление/сброс/скип — из уведомления и экрана.
* Три вибро‑паттерна на рубежах секций, четвёртый — на финале.
* Сохранение/восстановление состояния.

### Нефункциональные

* Работает автономно на часах (standalone).
* Энергопрофиль: тики 1–2 с; экран не удерживается включённым.
* Надёжность: корректная работа в Doze; точность рубежей не хуже ±1–2 с.
* Доступность: большой шрифт, высокий контраст; управление одной кнопкой.
* Разрешения: на Wear OS 5 (API 34) используем `USE_EXACT_ALARM`, поэтому спец-доступ не отображается в настройках. На Wear OS 3.x (API 31–32) остаётся требование к «Будильники и напоминания» (`SCHEDULE_EXACT_ALARM`); без него приложение падает обратно на тики (возможна задержка до ~2 с в Doze).

### Платформа

* **Wear OS 5 / Android 14 (API 34)** — ориентир (Galaxy Watch 5).
* Эмулятор: Wear OS Large Round 454×454, Services = Google Play Store.

---

## Архитектура и компоненты

* **Приложение (Activity, Compose for Wear)** — список пресетов, редактор, запуск.
* **Tile (androidx.wear.tiles)** — быстрый старт/индикатор. Использует *Dynamic Time* для прогресса и *TileUpdateRequester* для событий (смена секции, пауза).
* **Foreground‑Service** — «движок» таймера; даёт постоянное уведомление и живучесть.
* **Хранилище** — DataStore (Preferences) для пресетов и `TimerState`.
* **Уведомление** — действия Pause/Resume/Stop/Skip, заголовок: «<пресет> • <фаза>».

**Варианты точности:**

* A) *AlarmManager.setExactAndAllowWhileIdle()* на T−10 обратного отсчёта + границу (основной путь: `USE_EXACT_ALARM` на API 33+, `SCHEDULE_EXACT_ALARM` иначе).
* B) Тики + коррекция по `elapsedRealtime()` — fallback при отсутствии доступа к точным будильникам (точность ±1–2 с в Doze).

---

## Состояния и основной поток (flow)

### Машина состояний

```
Idle → Running(INTRO) → boundary → Running(MAIN) → boundary → Running(OUTRO) → Done
          ↑ Pause ↔ Resume (всегда доступны)
          ↳ Skip → следующая секция
```

### Основной сценарий

1. Пользователь заранее выбирает дефолтный пресет.
2. На служении: свайп вправо → Tile → **Start**.
3. В конце каждой секции: вибро‑сигнал + смена фазы/цвета/подписи.
4. Пауза/Resume/Skip — из уведомления; при Done — финальный сигнал.
5. По завершении: Tile показывает «Готово/Start», уведомление снимается.

---

## Экраны, действия, маршрутизация

**A. Tile (виджет)**

* Содержимое: название дефолтного пресета; ProgressIndicator; метка фазы (I/M/O); большая кнопка Start или Pause/Resume.
* Действия: Tap = Start/Pause/Resume; «⋯» = открыть Activity (выбор пресета/настройки).

**B. Экран таймера (Activity)**

* Крупный обратный отсчёт текущей секции.
* Кнопки: Pause/Resume, Skip, Stop.
* Цвет/фон по фазе.

**C. Список пресетов**

* По 1 строке: имя + шаблон `5‑20‑5`.
* Долгое нажатие: редактировать/удалить; чекбокс «по умолчанию».

**D. Редактор пресета**

* Поля: имя; длительности (мин/сек, шаг 1 мин; опция 15 с).
* Переключатели: «Звук» (off по умолчанию), «Разрешить Skip» (on).
* Кнопки: Сохранить / Протестировать вибро.

**E. Уведомление (Foreground)**

* Заголовок: `<Preset> • <Фаза>`
* Текст: «Осталось: N\:SS»
* Действия: Pause/Resume, Skip, Stop.

Маршрутизация: Tile → Activity(Таймер) или Activity(Список) в зависимости от контекста.

---

## UX‑решения для зала/кафедры

* **Вибро‑паттерны различимы**:

  * Конец Intro: короткий двойной.
  * Конец Main: тройной, длиннее.
  * Конец Outro (Done): длинный‑короткий‑длинный.
* **Минимум визуального**: экран используется как подтверждение, а не как постоянный монитор.
* **Без звука по умолчанию**: чтобы не нарушать тишину.
* **Защита от двойного клика**: debounce на Start/Resume.

---

## Правила и крайние случаи

* Длительность секции = 0 → секция пропускается, подаётся короткий сигнал.
* Пауза > X минут (настраиваемо) → при возврате спросить: «Продолжить?» / «Сбросить?»
* Смена пресета при активном таймере: требуется Stop (явно).
* Низкая батарея (<10%): предупредить о возможной задержке сигналов.
* Перезагрузка часов: восстановить из DataStore (рассчитать остаток по монотонным часам).

---

## Конфиденциальность и безопасность

* Приложение **не собирает личные данные** и **не отправляет наружу** статистику.
* Вся информация локальна: пресеты, состояние таймера.
* Разрешения: звук (опционально), вибрация — системный сервис; **Exact alarm** (если выбран вариант A) — только для конечных рубежей.

---

## Сборка и запуск (для разработчика)

1. **IDE:** Android Studio (стабильная).
2. **SDK/AVD:** Wear OS Large Round; **API 34 / Android 14**; **Services = Google Play Store**; образ: *Wear OS 5 ARM64 v8a*.
3. **Run:** запусти эмулятор → выбери модуль *wear* → Run.
4. **Реальные часы:** включить Developer Options → ADB over Wi‑Fi → `adb connect <ip>:5555` → Run/Install.
5. **Exact alarms:** Settings → Apps & notifications → Special app access → **Alarms & reminders** → включи Sermon Timer (на эмуляторе: Settings → Apps → Special app access → Alarms & reminders). Иначе обратный отсчёт T−10 в Doze может работать с задержкой.
6. **Профили сборки:** `debug` (короткие пресеты 5‑10‑5 сек, логи), `release` (реальные длительности, минимум логирования).

---

## Тест‑план (качество и надёжность)

**Функциональные тесты**

* Старт из Tile; пауза/возобновление/сброс/скип.
* Правильные вибро‑паттерны на рубежах.
* Нулевая секция; длинная пауза; смена пресета при активном таймере (запрет).

**Надёжность**

* Doze/Idle: `adb shell cmd deviceidle force-idle` — рубежи приходят в срок.
* Убийство процесса: `adb shell am force-stop <pkg>` — восстановление состояния.
* Перезагрузка часов — ожидаемое поведение (продолжение/завершение по политике).
* Низкий заряд: корректные предупреждения, отсутствие фризов.

**UX**

* Читаемость экрана с расстояния \~50–70 см; понятность цветов/меток I/M/O.
* Debounce на кнопках; защита от случайных двойных тапов.

**Диагностика**

* Логи фаз/событий; `dumpsys alarm`, `dumpsys activity services` для контроля сервисов/алармов.

---

## Ограничения платформы и компромиссы

* **Tiles** не позволяют произвольные ежесекундные перерисовки; используем *Dynamic Time* для прогресса и пушим апдейты только на событиях.
* **Foreground‑сервис** обязателен для живучести; это даёт «иконку» и постоянное уведомление — осознанный компромисс.
* **Звук** на часах в зале спорен; по умолчанию выключен.

---

## Дорожная карта

* **MVP**: пресеты, Tile‑старт, сервис, уведомление, вибро‑рубежи, пауза/скип, восстановление.
* **v1.1**: компликация-индикатор; экран теста вибро; экспорт/импорт пресетов (строкой/QR).
* **v1.2**: «умное заключение» — автосжатие outro при перерасходе основной; настройка стратегии.
* **v1.3**: «режим ведущего» (фикс. общий слот, адаптивная переразметка секций); телеметрия **локально** (без сети).

---

## Глоссарий

* **Tile** — системный «виджет» на Wear OS, доступный свайпом вправо.
* **Complication** — элемент на циферблате с данными приложения.
* **Foreground‑service** — сервис с постоянным уведомлением, повышающим приоритет выполнения.
* **Doze/Idle** — режимы энергосбережения, ограничивающие фоновые задачи.
* **Dynamic Time** — механизм Tiles для привязки прогресса ко времени без ручной перерисовки.

---

## Default
* «по умолчанию»: **вибро‑режим On, звук Off, разрешён Skip**, максимум 5 пресетов, целевая платформа API 34.
