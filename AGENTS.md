# AGENTS.md — Operating Guide for AI Agents (Codex CLI, etc.)

> Репозиторий: **Three‑Part Timer for Wear OS (Galaxy Watch 5)**
> Цель файла: дать ИИ‑агентам (Codex CLI и др.) **точные, проверяемые инструкции** по работе с кодовой базой: область задач, ограничения, команды, стиль, критерии приёмки, правила верификации и источники best practices.

---

## 0) TL;DR для агентов

* Что строим: **трёхсекционный таймер** (*Intro → Main → Outro*) с хаптикой на рубежах, **Tile** для быстрого старта (свайп вправо), **Foreground Service** для надёжности.
* Основные поверхности: Tile (Start/Pause/Resume), уведомление (Pause/Resume/Skip/Stop), Activity (пресеты, таймер).
* Платформа: **Wear OS 5 / Android 14 (API 34)**; minSdk (Wear) ≥ **30** (поддержка Wear OS 3+).
* Запреты: нет зависимости от телефона, сети, аккаунтов, рекламы, телеметрии по умолчанию.
* Качество: надёжность > анимации; вибро > звук; простота > обилие фич.

**Нулевая допущенность предположений** → см. §1.3 и §6 «Политика фактов и best practices».

---

## 1) Область задач и запреты

### 1.1 В scope

* Standalone‑приложение под часы: **пресеты**, **трёхсекционный таймер**, **Tile‑старт**, **хаптика на границах**, **пауза/скип/стоп**, **восстановление состояния** после перезапуска/краша/ребута.
* Прогресс на Tile через **Dynamic Time**; события (старт/пауза/граница/стоп) — через **TileUpdateRequester**.

### 1.2 Out of scope (не делаем)

* Сеть, аккаунты, синхронизация, companion phone, push, покупки, реклама.
* Вечные wakelock’и, фоновая работа без foreground‑уведомления.

### 1.3 **Политика фактов и проверок (Zero‑Assumptions)**

* **Никаких предположений.** Любое решение/настройка должно опираться на **проверяемые факты**: официальную документацию, исходники библиотек, воспроизводимые эксперименты.
* Если факт отсутствует → **остановиться**, создать мини‑RFC/issue с формулировкой вопроса и планом проверки; выполнить минимальный «spike»‑эксперимент, зафиксировать результаты.
* Любая неоднозначность должна быть **сведена к тесту** (unit/instrumentation) или к чётко измеряемой проверке на эмуляторе/устройстве.

---

## 2) Архитектура (высокоуровнево)

```
app/
 ├─ data/           # DataStore (пресеты, последнее состояние)
 ├─ domain/         # Движок таймера, модели, машина состояний
 ├─ service/        # ForegroundService, AlarmManager (если используем)
 ├─ tile/           # TileService + ProtoLayout (Dynamic Time)
 ├─ ui/             # Compose for Wear (экраны: список, редактор, таймер)
 ├─ util/           # вибро‑хелперы, time utils, логирование
 └─ tests/          # unit + instrumentation
```

* Движок: общий обратный отсчёт + **checkpoints** на трёх границах.
* Надёжность: работа внутри **ForegroundService**; границы — через exact‑alarms **или** коррекцию по `elapsedRealtime()`.
* Tile: имя пресета, фаза (I/M/O), кольцевой прогресс; апдейты → TileUpdateRequester.
* Уведомление: постоянно, действия Pause/Resume/Skip/Stop.
* Состояние: `DataStore` хранит `TimerState` + выбранный пресет для восстановления.

---

## 3) Доменная модель

```kotlin
data class Preset(
  val id: String,
  val title: String,
  val introSec: Int,
  val mainSec: Int,
  val outroSec: Int,
  val allowSkip: Boolean = true,
  val soundEnabled: Boolean = false
)

enum class Segment { INTRO, MAIN, OUTRO, DONE }
enum class RunStatus { IDLE, RUNNING, PAUSED, DONE }

data class TimerState(
  val status: RunStatus,
  val segment: Segment,
  val remainingInSegmentSec: Int,
  val elapsedTotalSec: Int,
  val totalSec: Int,
  val startedAtElapsedRealtime: Long?
)
```

**Инварианты:** `total = intro + main + outro`; при 0‑длительности фаза мгновенно пропускается с короткой хаптикой.

---

## 4) UX‑принципы (обязательно)

1. Хаптика **включена по умолчанию**, звук — **выключен** (уважение к DND/зал).
2. На Tile одна большая контекстная кнопка: Start или Pause/Resume.
3. На экране таймера крупно показываем **остаток текущей секции** + явная метка I/M/O.
4. Debounce/идемпотентность на Start/Resume; защита от двойного старта.
5. 0‑секции — мгновенный пропуск, короткий сигнал.

---

## 5) Платформа и зависимости

* target/compile: **API 34**; minSdk (wear): **30**.
* UI: **Jetpack Compose for Wear**; Tiles: **androidx.wear.tiles (ProtoLayout)**.
* Foreground‑канал нотификаций: `"timer"`.
* Разрешение `SCHEDULE_EXACT_ALARM` — **только при фактическом использовании** exact‑alarms и после оценки альтернатив (см. §6).

---

## 6) **Политика фактов и best practices** (обязательно к исполнению)

1. **Zero‑Assumptions.** Не придумывать поведение «по аналогии» — только подтверждённые факты.
2. **Верификация перед выбором техники.** Если есть варианты имплементации (напр. exact‑alarms vs. тики + `elapsedRealtime()`):

   * собрать **минимальный тест** на эмуляторе (и по возможности на устройстве),
   * измерить точность рубежей, энергопрофиль, поведение в Doze,
   * зафиксировать результаты в описании PR (краткая таблица/пункты).
3. **Поиск best practices в интернете:**

   * при ошибках, выборе библиотек, архитектурных приёмах — **обязательно** просмотреть **официальную документацию** (Android/Wear, Jetpack), релизы библиотек, issue‑трекеры, образцы кода из официальных репозиториев;
   * дополнительно — статьи Google Developers/Medium/Stack Overflow **с критической проверкой дат** (не старше 18 месяцев, если технология быстро меняется);
   * в PR приложить 3–5 ссылок на источники, кратко резюмировать, почему выбран подход.
4. **Побеждает официальный источник.** При конфликте — приоритет: официальные доки/исходники > статьи/блоги > ответы на форумах.
5. **Повторяемость.** Любое утверждение о поведении системы подкрепляется шагами воспроизведения (adb‑команды/настройки эмулятора).

---

## 7) Сборка, запуск, тесты (команды)

```bash
# build & install
yarn -s >/dev/null 2>&1 || true  # (если есть фронт-инструменты; иначе игнор)
./gradlew :app:assembleDebug
./gradlew :app:installDebug

# unit-тесты движка
./gradlew :app:testDebug

# instrumentation (smoke на Wear AVD)
./gradlew :app:connectedDebugAndroidTest

# формат/линт (выбрать, что настроено в проекте)
./gradlew spotlessApply detekt
# или
./gradlew ktlintFormat ktlintCheck
```

**AVD:** Wear OS Large Round, **API 34 / Android 14**, Services = **Google Play Store**, образ: *Wear OS 5 ARM64 v8a*.
**Реальные часы:** Developer Options → ADB over Wi‑Fi → `adb connect <ip>:5555`.

---

## 8) Стандарты кодирования

* Kotlin only; Compose UI; без новых XML‑layout’ов.
* Пакеты — feature‑first (см. структуру выше); избегать god‑objects.
* Именование: `TimerService`, `SermonTileService`, `PresetEditorScreen`, `TimerEngine`.
* Иммутабельность по умолчанию; состояние через Flow/State.
* Ошибки: в debug — fail‑fast; в release — безопасные дефолты (отрицательные длительности ⇒ 0).
* Логи: теги `TIMER`, `TILE`, `SRV`; без PII; в release — минимум шума.
* Ресурсы: строки/цвета централизованы; RU/EN локали по возможности.

---

## 9) Критерии приёмки (для PR)

Изменение **приемлемо**, если выполнено всё:

* ✅ Сборка под **API 34** проходит; установка и запуск на Wear AVD успешны.
* ✅ Unit‑тесты домена «движок таймера» зелёные; instrumentation‑smoke зелёный.
* ✅ Хаптика на всех границах; 0‑секции корректно обрабатываются.
* ✅ Tile показывает верную фазу/прогресс; обновляется при boundary/pause/resume.
* ✅ Foreground‑уведомление всегда активно во время работы; действия работают.
* ✅ **Применена политика §6**: в PR есть список источников (3–5 ссылок) и краткая проверка подхода.
* ✅ Нет новых permissions без обоснования; звук по умолчанию Off.
* ✅ Обновлены README и/или этот AGENTS.md, если менялось поведение/команды/ограничения.

---

## 10) Машина состояний и управление

```
IDLE
 └─ Start(preset) → RUNNING(INTRO|MAIN|OUTRO)
RUNNING(segment)
 ├─ tick → update remaining
 ├─ boundary → haptic + next segment
 ├─ Pause → PAUSED(segment)
 ├─ Skip  → next segment (если allowSkip)
 └─ Stop  → IDLE
PAUSED(segment)
 ├─ Resume → RUNNING(segment)
 └─ Stop   → IDLE
DONE
 └─ Stop/Reset → IDLE
```

**Хаптика границ:** Intro: короткий двойной; Main: тройной длиннее; Outro/Done: long–short–long.

---

## 11) Tile и уведомление — правила

* Tile использует **DynamicTime** для плавного прогресса; репуш по событиям: start/pause/resume/boundary/stop/done.
* Большая кнопка на Tile = Start/Resume либо Pause (контекстно).
* Уведомление: действия **Pause / Resume / Skip / Stop**; заголовок `"<Preset> • <Phase>"`, текст `"Remaining: mm:ss"` + общий прогресс.

---

## 12) Данные и персистентность

* `DataStore` хранит: список `presets`, `default_preset_id`, сериализованный `last_timer_state`.
* При запуске процесса и `status ∈ {RUNNING, PAUSED}`:

  * пересчитать остаток по `elapsedRealtime()`; восстановить или корректно завершить.

---

## 13) Надёжность и энергия

* Предпочтительно exact‑alarms на границах (если разрешено политикой и реально улучшают точность); иначе — тики 1–2 с + коррекция по `elapsedRealtime()`.
* Не удерживать экран; не держать ручных wakelock’ов; полагаться на ForegroundService.

---

## 14) Security & Privacy

* Нет сети/облака; нет внешнего хранилища; нет аккаунтов.
* Логи — только техничские события; без пользовательских данных.
* Звук уважает DND; по умолчанию выключен.

---

## 15) DX‑процесс для агентов

**Перед изменениями:**

1. Прочитать README и AGENTS.md.
2. Проверить версии (API 34, Wear OS 5).
3. Оценить варианты реализации → применить §6 (поиск best practices + мини‑верификация).

**При добавлении фичи:**

* Сначала домен (чистый Kotlin) + unit‑тесты; затем Service/Tile/UI; затем instrumentation‑smoke.
* В PR приложить ссылки на источники и краткий итог выбора.

**При изменении поведения:**

* Сохранить обратную совместимость пресетов; при миграции — мигратор.
* Обновить документацию и критерии в этом файле.

---

## 16) Ветвление, коммиты, PR

* trunk‑based, короткоживущие ветки.
* Conventional Commits: `feat(tile): ...`, `fix(service): ...` и т. п.
* В PR: скриншоты/GIF для UI/Tile, список источников (§6), заметка про энергию/точность, если затронуто.

---

## 17) Матрица тестов (локально для агентов)

* Функционал: старт с Tile; pause/resume/skip/stop; 0‑секций; Done.
* Надёжность: `adb shell am force-stop <pkg>` → восстановление; `adb shell cmd deviceidle force-idle` → точность границ.
* Устройства: Wear AVD API 34 + (при наличии) реальные Galaxy Watch 5 (ADB‑over‑Wi‑Fi).
* Производительность: CPU не «залипает», батарея в норме, UI без рывков.

---

## 18) Guard‑Rails (жёсткие запреты)

* ❌ Тихие предположения без проверки фактами/экспериментом.
* ❌ Добавление зависимости от телефона/сети/аккаунтов.
* ❌ Замена ForegroundService на чистый бэкграунд без уведомления.
* ❌ Попытка «тикать» Tile каждую секунду кастомной перерисовкой.
* ❌ Новые разрешения без явного обоснования и документации.
* ❌ Любая телеметрия/PII/секреты в коде или логах.

---

## 19) Флаги (feature toggles)

* `useExactBoundaryAlarms` (default: false) — перейти на AlarmManager для границ.
* `enableSounds` (default: false) — звуки на границах с уважением DND.
* `smartOutro` (default: false) — сжатие Outro при перерасходе Main.

Документируйте любое изменение флагов в README и здесь.

---

## 20) Глоссарий

Tile — свайп‑право виджет Wear OS;  Complication — слот данных на циферблате;
Dynamic Time — привязка прогресса ко времени без активной перерисовки;
ForegroundService — сервис с постоянным уведомлением;  Doze/Idle — энергосбережение.
