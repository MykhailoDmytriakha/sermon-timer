# TESTS

## Термины

- **Tile** — системный экран Wear OS, доступный свайпом вправо; даёт одну крупную кнопку для запуска или управления таймером.
- **ProtoLayout** — язык для описания содержимого Tile; тестировщик видит его результат как фиксированную раскладку элементов (кнопка, текст, прогресс) без лагов.
- **Dynamic Time** — функция ProtoLayout: указываем время старта и длительность, и Tile сам считает прогресс; тесту важно лишь, что кольцо уменьшается плавно без ручных обновлений.
- **Хаптика** — виброотклик часов; для проверки следим, что нужный вибро-паттерн приходит на границах и отличается по длине/интенсивности.
- **Foreground Service** — сервис с постоянным уведомлением, гарантирующий работу таймера в фоне и защиту от выгрузки.
- **Preset** — сохранённый набор длительностей сегментов (Intro/Main/Outro) и опций, выбранный по умолчанию для быстрого старта.
- **Segment** — активная часть таймера (Intro, Main или Outro), для которой отображается остаток времени и хаптика на границах.

## Функциональные сценарии

1. **Старт с Tile и отображение прогресса**
   - Выбрать дефолтный пресет в приложении.
   - На часах открыть Tile и нажать `Start`.
   - Убедиться, что: таймер пошёл с Intro, на Tile активен кольцевой прогресс с Dynamic Time, на уведомлении отображается текущая фаза.

2. **Пауза и возобновление с Tile и уведомления**
   - Во время работы таймера нажать `Pause` на Tile.
   - Проверить, что таймер останавливается, Tile и уведомление показывают `Resume`, остаток времени не убывает.
   - Нажать `Resume` на уведомлении и убедиться, что счёт возобновился с корректным остатком.

3. **Управление с экрана таймера**
   - Открыть Activity таймера, запустить пресет.
   - Использовать кнопки `Pause`, `Skip`, `Stop` на экране.
   - Убедиться, что смена фазы, остаток и статус совпадают с ожидаемым поведением машины состояний.

4. **Пресеты: создание и выбор**
   - Создать новый пресет с разными длительностями Intro/Main/Outro.
   - Назначить его дефолтным и запустить из Tile.
   - Проверить, что отображаемые значения соответствуют созданному пресету.

5. **Запрет смены пресета во время активного таймера**
   - Запустить таймер.
   - Попробовать выбрать другой пресет.
   - Убедиться, что смена заблокирована или предложено завершить текущий таймер.

6. **Обработка нулевой секции**
   - Создать пресет с `introSec = 0` или другой нулевой секцией.
   - Запустить таймер и убедиться, что фаза с нулевой длительностью мгновенно пропускается с короткой хаптикой.

7. **Хаптика на рубежах**
   - Запустить пресет с заметными длительностями.
   - На переходах Intro→Main, Main→Outro и на завершении убедиться, что срабатывают разные вибро‑паттерны (двойной, тройной, long‑short‑long).

8. **Восстановление состояния Activity**
   - Запустить таймер, свернуть Activity и вернуться.
   - Проверить, что UI синхронизирован с текущим состоянием сервиса (фаза, оставшееся время).

9. **Foreground‑уведомление**
   - При любом запущенном таймере убедиться, что уведомление не исчезает, даже при переходе приложения в фон.
   - Проверить доступность действий `Pause/Resume/Skip/Stop` и корректную реакцию на них.

10. **Звук по умолчанию выключен**
    - Запустить таймер на устройстве с выключенным звуком.
    - Убедиться, что воспроизводится только вибрация, звуков нет без явного включения опции.

## Надёжность и восстановление

11. **Force‑stop процесса**
    - Запустить таймер, запомнить текущую фазу и остаток.
    - Выполнить `adb shell am force-stop <package>`.
    - Перезапустить приложение: убедиться, что состояние восстановлено по данным DataStore (фаза и остаток пересчитаны по `elapsedRealtime()`).

12. **Перезагрузка часов**
    - Запустить таймер, перезагрузить устройство/AVD.
    - Проверить после загрузки, что приложение возобновляет/завершает таймер согласно сохранённому состоянию и уведомление восстанавливается.

13. **Doze/Idle**
    - Во время работы таймера выполнить `adb shell cmd deviceidle force-idle`.
    - Наблюдать переходы между фазами: рубежи должны происходить с допустимой задержкой, корректные вибро‑паттерны сохраняются.

14. **Низкий заряд батареи**
    - Симулировать уровень батареи <10% (через эмулятор или реальные часы).
    - Убедиться, что таймер продолжает работать, даёт предупреждение (если реализовано) и не теряет вибро‑сигналы.

15. **Длительная пауза**
    - Поставить таймер на паузу минимум на 10 минут.
    - Проверить, что по возобновлению остаток времени корректный; нет «перепрыгивания» фаз.

16. **Boundary drift коррекция**
    - Сравнить ожидаемое время окончания каждой фазы с фактическим (по часам или логам).
    - Убедиться, что накопленный дрейф не превышает спецификации (с учётом выбранной стратегии: exact alarms или коррекция по `elapsedRealtime()`).

## UX и доступность

17. **Читаемость таймера**
    - На расстоянии 50–70 см проверить, что крупные цифры остатка и метка сегмента (I/M/O) читаемы.
    - Оценить контраст и соответствие цветов требованиям.

18. **Debounce кнопок**
    - Быстро нажать `Start` дважды подряд на Tile и в Activity.
    - Убедиться, что таймер не стартует два раза и состояние не ломается.

19. **Маркировка фаз**
    - Для каждой фазы проверить отображение названия сегмента и прогресса (цвет или подпись).
    - Убедиться, что пользователю очевидно, какая часть сейчас идёт.

20. **Tile без активного таймера**
    - Остановить таймер и открыть Tile.
    - Проверить, что показан дефолтный пресет и единственная большая кнопка `Start`.

## Данные и настройки

21. **Сохранение пресетов в DataStore**
    - После создания/редактирования пресета перезапустить приложение.
    - Проверить, что список пресетов и дефолтный выбор восстановлены.

22. **Флаги и настройки**
    - Если включены флаги `useExactBoundaryAlarms`, `enableSounds`, `smartOutro`, убедиться, что изменения задокументированы и соответствуют политикам (звуки уважают DND, Exact Alarm используется только при необходимости).

23. **Отсутствие лишних разрешений**
    - Проверить `AndroidManifest` и диалог разрешений: нет запросов на сеть, аккаунты, телеметрию.

## Диагностика и наблюдаемость

24. **Логи сервисов**
    - Запустить таймер и собрать `adb logcat` по тегам `TIMER`, `TILE`, `SRV`.
    - Убедиться, что в логах фиксируются ключевые события (старт, пауза, рубеж), и отсутствуют персональные данные.

25. **Системные дампы**
    - Выполнить `adb shell dumpsys alarm` и `adb shell dumpsys activity services`.
    - Проверить, что активные алармы и ForegroundService соответствуют текущему состоянию таймера.
